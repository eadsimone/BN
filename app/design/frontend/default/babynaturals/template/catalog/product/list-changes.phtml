<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2009 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Product list template
 *
 * @see Mage_Catalog_Block_Product_List
 */
?>

<?php //$_productCollection=$this->getLoadedProductCollection() ?>
<?php //if(!$_productCollection->count()): ?>
<p class="note-msg"><?php echo $this->__('There are no products matching the selection.') ?></p>
<?php //else: ?>
<div class="category-products">
    <?php //echo $this->getToolbarHtml() ?>
    
    <?php // Grid Mode ?>

    <!--- Custom Code Begin --->
	
    
    <?php

// specify the attribute code
$attributeCode = 'bn_brand';

// build and filter the attribute collection
$attrCollection = Mage::getResourceModel('catalog/product_collection')
        ->addAttributeToFilter($attributeCode, array('notnull' => true))
        ->addAttributeToFilter($attributeCode, array('neq' => ''))
        ->addAttributeToSelect($attributeCode);

// create an array of all of the unique ids for the attribute code
$usedAttributeValues = array_unique($attrCollection->getColumnValues($attributeCode));

var_dump($usedAttributeValues);

foreach($usedAttributeValues as $attrValue) { 


?>
 
		
	
<?php    

//NOTE: This did exactly what I thought it would. It loops through everything by brand, but the logic for the current category is lost. All of that appears to reside inside the getLoadedProductCollection function. Which has an issue if you apply the addFieldToFilter value more than once in a loop. Need to figure out how to get the filter to work on that collection. Probably need to extend the block vs. trying to do it in the phtml with a loop.


$model = Mage::getModel('catalog/product');
		$_productCollection = $model->getCollection();
		$_productCollection->addFieldToFilter('bn_brand', $attrValue);
		$_productCollection->addAttributeToSelect('name');
		$_productCollection->load();


    //$_productCollection=$this->getLoadedProductCollection(); 
	//$_productCollection = clone $this->getLoadedProductCollection();
	//$_productCollection->addFieldToFilter('bn_brand', $attrValue);
	//$_productCollection->clear()
     //             ->addFieldToFilter('bn_brand', $attrValue) 
     //             ->load();
	
	//$_productCollection = clone $this->getLoadedProductCollection();
	//$attrValue = '42';
	//$_productCollection->clear()
     //              ->addFieldToFilter('bn_brand', $attrValue) 
     //              ->load();
    ?>
	
	<?php $_columnCount = $this->getColumnCount(); ?>
 <?php 
		$attributeModel = Mage::getSingleton('eav/config')
	    ->getAttribute('catalog_product', $attributeCode);
 		$attrName = $attributeModel->getSource()->getOptionText($attrValue);
		?>
        <h1><?php echo $attrName; ?> </h1>
	
  <!-- End Custom Code -->  
    
    <?php $i=0; foreach ($_productCollection as $_product): ?>
        <?php if ($i++%$_columnCount==0): ?>
       
        <ul class="products-grid">
        <?php endif ?>
            <li class="item<?php if(($i-1)%$_columnCount==0): ?> first<?php elseif($i%$_columnCount==0): ?> last<?php endif; ?>">
                <?php Mage::helper('quicksee')->display($_product);?>
                <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->htmlEscape($this->getImageLabel($_product, 'small_image')) ?>" class="product-image"><img src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(170); ?>" width="170" height="170" alt="<?php echo $this->htmlEscape($this->getImageLabel($_product, 'small_image')) ?>" /></a>
                <p class="brand-name" style="margin:0;padding:0;line-height:16px;"><?php echo $_product->getAttributeText('bn_brand'); ?></p>
                <h2 class="product-name" style="margin:0;padding:0;"><a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->htmlEscape($_product->getName()) ?>"><?php echo $this->htmlEscape($_product->getName()) ?></a></h2>
				<p class="sub-desc"><?php echo $_product->getBn_subdesc(); ?></p>
                <?php if($_product->getRatingSummary()): ?>
                <?php echo $this->getReviewsSummaryHtml($_product, 'short') ?>
                <?php endif; ?>
                <?php echo $this->getPriceHtml($_product, true) ?>
                <div class="actions">
                    <?php if($_product->isSaleable()): ?>
                        <button type="button" title="<?php echo $this->__('Add to Cart') ?>" class="button btn-cart" onclick="setLocation('<?php echo $this->getAddToCartUrl($_product) ?>')"><span><span><?php echo $this->__('Add to Cart') ?></span></span></button>
                    <?php else: ?>
                        <p class="availability out-of-stock"><span><?php echo $this->__('Out of stock') ?></span></p>
                    <?php endif; ?>
                    <ul class="add-to-links" style="display:none;">
                        <?php if ($this->helper('wishlist')->isAllow()) : ?>
                            <li><a href="<?php echo $this->helper('wishlist')->getAddUrl($_product) ?>" class="link-wishlist"><?php echo $this->__('Add to Wishlist') ?></a></li>
                        <?php endif; ?>
                        <?php if($_compareUrl=$this->getAddToCompareUrl($_product)): ?>
                            <li><span class="separator">|</span> <a href="<?php echo $_compareUrl ?>" class="link-compare"><?php echo $this->__('Add to Compare') ?></a></li>
                        <?php endif; ?>
                    </ul>
                </div>
            </li>
        <?php if ($i%$_columnCount==0 || $i==$_collectionSize): ?>
        </ul>
        <?php endif ?>
        <?php endforeach ?>
        <script type="text/javascript">decorateGeneric($$('ul.products-grid'), ['odd','even','first','last'])</script>
<?php


}

?>

    <?php //endif; ?>
    <div class="toolbar-bottom" style="display:none;">
        <?php echo $this->getToolbarHtml() ?>
    </div>
</div>

